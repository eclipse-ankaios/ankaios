{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "desiredState",
  "description": "A message containing the state information.",
  "type": "object",
  "properties": {
    "apiVersion": {
      "description": "The current version of the API.",
      "type": "string"
    },
    "configs": {
      "description": "Configuration values which can be referenced in workload configurations.",
      "allOf": [
        {
          "$ref": "#/definitions/configMap"
        }
      ],
      "default": {}
    },
    "workloads": {
      "description": "A mapping from workload names to workload configurations.",
      "allOf": [
        {
          "$ref": "#/definitions/workloadMap"
        }
      ],
      "default": {}
    }
  },
  "required": [
    "apiVersion"
  ],
  "definitions": {
    "accessRightsRule": {
      "description": "A message containing an allow or deny rule.",
      "type": "object",
      "oneOf": [
        {
          "description": "Rule for getting or setting the state",
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "StateRule"
            }
          },
          "allOf": [
            {
              "$ref": "#/definitions/stateRule"
            }
          ],
          "required": [
            "type"
          ]
        },
        {
          "description": "Rule for getting workload logs",
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "LogRule"
            }
          },
          "allOf": [
            {
              "$ref": "#/definitions/logRule"
            }
          ],
          "required": [
            "type"
          ]
        }
      ]
    },
    "addCondition": {
      "description": "An enum type describing the expected workload state. Used for dependency management.",
      "oneOf": [
        {
          "description": "The workload is operational.",
          "type": "string",
          "const": "ADD_COND_RUNNING"
        },
        {
          "description": "The workload has successfully exited.",
          "type": "string",
          "const": "ADD_COND_SUCCEEDED"
        },
        {
          "description": "The workload has exited with an error or could not be started.",
          "type": "string",
          "const": "ADD_COND_FAILED"
        }
      ]
    },
    "configArray": {
      "description": "A container for the array of config items.",
      "type": "array",
      "items": {
        "$ref": "#/definitions/configItem"
      }
    },
    "configItem": {
      "description": "A configuration can be a simple string or a mapping or an array\nof other configurations items.\n\nThis is a test comment.",
      "allOf": [
        {
          "$ref": "#/definitions/configItemEnum"
        }
      ]
    },
    "configItemEnum": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "$ref": "#/definitions/configArray"
        },
        {
          "$ref": "#/definitions/configObject"
        }
      ]
    },
    "configMap": {
      "description": "This is a workaround for proto not supporting optional maps",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/configItem"
      }
    },
    "configObject": {
      "description": "A container for the mapping of config items.",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/configItem"
      }
    },
    "controlInterfaceAccess": {
      "description": "A message containing the parts of the control interface the workload as authorized to access.\nBy default, all access is denied.\nOnly if a matching allow rule is found, and no matching deny rules is found, the access is allowed.",
      "type": "object",
      "properties": {
        "allowRules": {
          "description": "Rules allow the access",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/definitions/accessRightsRule"
          }
        },
        "denyRules": {
          "description": "Rules denying the access",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/definitions/accessRightsRule"
          }
        }
      }
    },
    "file": {
      "description": "A message describing a file with a mount point and file content.",
      "type": "object",
      "properties": {
        "mountPoint": {
          "description": "The path where the file is mounted inside the workload.",
          "type": "string"
        }
      },
      "anyOf": [
        {
          "description": "The content of the file.",
          "type": "object",
          "properties": {
            "data": {
              "type": "string"
            }
          },
          "required": [
            "data"
          ]
        },
        {
          "description": "The base64 encoded content of the file.",
          "type": "object",
          "properties": {
            "binaryData": {
              "type": "string"
            }
          },
          "required": [
            "binaryData"
          ]
        }
      ],
      "required": [
        "mountPoint"
      ]
    },
    "logRule": {
      "description": "Message containing a rule for getting workload logs.",
      "type": "object",
      "properties": {
        "workloadNames": {
          "description": "The names of the workloads the rule applies to. If empty, the rule does not apply to any workload. Wildcard \"\\*\" can be used to match all workloads.",
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "workloadNames"
      ]
    },
    "readWriteEnum": {
      "description": "An enum type describing if reads and/or write actions are allowed.",
      "oneOf": [
        {
          "description": "Allow nothing",
          "type": "string",
          "const": "Nothing"
        },
        {
          "description": "Allow read",
          "type": "string",
          "const": "Read"
        },
        {
          "description": "Allow write",
          "type": "string",
          "const": "Write"
        },
        {
          "description": "Allow read and write",
          "type": "string",
          "const": "ReadWrite"
        }
      ]
    },
    "restartPolicy": {
      "description": "An enum type describing the restart behavior of a workload.",
      "oneOf": [
        {
          "description": "The workload is never restarted. Once the workload exits, it remains in the exited state.",
          "type": "string",
          "const": "NEVER"
        },
        {
          "description": "If the workload exits with a non-zero exit code, it will be restarted.",
          "type": "string",
          "const": "ON_FAILURE"
        },
        {
          "description": "The workload is restarted upon termination, regardless of the exit code.",
          "type": "string",
          "const": "ALWAYS"
        }
      ]
    },
    "stateRule": {
      "description": "Message containing a rule for getting or setting the state",
      "type": "object",
      "properties": {
        "filterMasks": {
          "description": "Paths defining what can be accessed. Segments of path can be a wildcard \"\\*\".",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "operation": {
          "description": "Defines which actions are allowed",
          "allOf": [
            {
              "$ref": "#/definitions/readWriteEnum"
            }
          ]
        }
      },
      "required": [
        "operation",
        "filterMasks"
      ]
    },
    "workload": {
      "description": "A message containing the configuration of a workload.",
      "type": "object",
      "properties": {
        "agent": {
          "description": "The name of the owning Agent.",
          "type": "string"
        },
        "configs": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "controlInterfaceAccess": {
          "allOf": [
            {
              "$ref": "#/definitions/controlInterfaceAccess"
            }
          ],
          "default": {
            "allowRules": [],
            "denyRules": []
          }
        },
        "dependencies": {
          "description": "A mapping from a workload name to an expected state.",
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/addCondition"
          },
          "default": {}
        },
        "files": {
          "description": "A vector with files assigned to a workload.",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/definitions/file"
          }
        },
        "restartPolicy": {
          "description": "An enum value that defines the condition under which a workload is restarted.",
          "allOf": [
            {
              "$ref": "#/definitions/restartPolicy"
            }
          ],
          "default": "NEVER"
        },
        "runtime": {
          "description": "The name of the runtime e.g. podman.",
          "type": "string"
        },
        "runtimeConfig": {
          "description": "The configuration information specific to the runtime.",
          "type": "string"
        },
        "tags": {
          "description": "Tags describing custom properties.",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        }
      },
      "required": [
        "agent",
        "runtime",
        "runtimeConfig"
      ]
    },
    "workloadMap": {
      "description": "This is a workaround for proto not supporting optional maps",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/workload"
      }
    }
  }
}