<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1051px" preserveAspectRatio="none" style="width:1445px;height:1051px;background:#FFFFFF;" version="1.1" viewBox="0 0 1445 1051" width="1445px" zoomAndPan="magnify"><defs/><g><rect fill="#EEEEEE" height="1032.625" style="stroke:#D3D3D3;stroke-width:0.5;" width="1149" x="11" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="110" x="530.5" y="18.0669">Ankaios Server</text><rect fill="#EEEEEE" height="1032.625" style="stroke:#D3D3D3;stroke-width:0.5;" width="121" x="1182" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1189" y="18.0669">Ankaios Agent</text><rect fill="#FFFFFF" height="946.8984" style="stroke:#181818;stroke-width:1.0;" width="10" x="33" y="88.7266"/><rect fill="#FFFFFF" height="28" style="stroke:#181818;stroke-width:1.0;" width="10" x="38" y="125.8594"/><rect fill="#FFFFFF" height="835.6328" style="stroke:#181818;stroke-width:1.0;" width="10" x="323" y="199.9922"/><rect fill="#FFFFFF" height="559.4531" style="stroke:#181818;stroke-width:1.0;" width="10" x="328" y="476.1719"/><rect fill="#FFFFFF" height="273.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="333" y="762.4297"/><rect fill="#FFFFFF" height="34.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="338" y="799.5625"/><rect fill="#FFFFFF" height="778.0391" style="stroke:#181818;stroke-width:1.0;" width="10" x="533" y="257.5859"/><rect fill="#FFFFFF" height="30" style="stroke:#181818;stroke-width:1.0;" width="10" x="538" y="329.3125"/><rect fill="#FFFFFF" height="28" style="stroke:#181818;stroke-width:1.0;" width="10" x="538" y="648.0313"/><rect fill="#FFFFFF" height="201.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="538" y="833.6953"/><rect fill="#FFFFFF" height="164.7969" style="stroke:#181818;stroke-width:1.0;" width="10" x="543" y="870.8281"/><rect fill="#FFFFFF" height="515.3203" style="stroke:#181818;stroke-width:1.0;" width="10" x="797.5" y="520.3047"/><rect fill="#FFFFFF" height="28" style="stroke:#181818;stroke-width:1.0;" width="10" x="802.5" y="575.8984"/><rect fill="#FFFFFF" height="630.1797" style="stroke:#181818;stroke-width:1.0;" width="10" x="1077.5" y="405.4453"/><rect fill="#FFFFFF" height="38.1992" style="stroke:#181818;stroke-width:1.0;" width="10" x="1082.5" y="724.2305"/><rect fill="#FFFFFF" height="778.0391" style="stroke:#181818;stroke-width:1.0;" width="10" x="1237.5" y="257.5859"/><rect fill="#FFFFFF" height="91.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="1242.5" y="944.2266"/><rect fill="#FFFFFF" height="16" style="stroke:#181818;stroke-width:1.0;" width="10" x="1247.5" y="1019.625"/><rect fill="none" height="76.2656" style="stroke:#000000;stroke-width:1.5;" width="888" x="421" y="291.0469"/><rect fill="none" height="61.3984" style="stroke:#000000;stroke-width:1.5;" width="888" x="421" y="890.8281"/><rect fill="none" height="61.3984" style="stroke:#000000;stroke-width:1.5;" width="888" x="421" y="966.2266"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="38" x2="38" y1="72.7266" y2="1044.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="328" x2="328" y1="207.6563" y2="1044.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="538" x2="538" y1="265.25" y2="1044.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="802" x2="802" y1="527.9688" y2="1044.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1082" x2="1082" y1="413.1094" y2="1044.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1242" x2="1242" y1="72.7266" y2="1044.625"/><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="15" y="41.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="22" y="61.4248">Main</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="113" x="1186" y="41.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99" x="1193" y="61.4248">Ankaios Agent</text><rect fill="#FFFFFF" height="946.8984" style="stroke:#181818;stroke-width:1.0;" width="10" x="33" y="88.7266"/><rect fill="#FFFFFF" height="28" style="stroke:#181818;stroke-width:1.0;" width="10" x="38" y="125.8594"/><rect fill="#FFFFFF" height="835.6328" style="stroke:#181818;stroke-width:1.0;" width="10" x="323" y="199.9922"/><rect fill="#FFFFFF" height="559.4531" style="stroke:#181818;stroke-width:1.0;" width="10" x="328" y="476.1719"/><rect fill="#FFFFFF" height="273.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="333" y="762.4297"/><rect fill="#FFFFFF" height="34.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="338" y="799.5625"/><rect fill="#FFFFFF" height="778.0391" style="stroke:#181818;stroke-width:1.0;" width="10" x="533" y="257.5859"/><rect fill="#FFFFFF" height="30" style="stroke:#181818;stroke-width:1.0;" width="10" x="538" y="329.3125"/><rect fill="#FFFFFF" height="28" style="stroke:#181818;stroke-width:1.0;" width="10" x="538" y="648.0313"/><rect fill="#FFFFFF" height="201.9297" style="stroke:#181818;stroke-width:1.0;" width="10" x="538" y="833.6953"/><rect fill="#FFFFFF" height="164.7969" style="stroke:#181818;stroke-width:1.0;" width="10" x="543" y="870.8281"/><rect fill="#FFFFFF" height="515.3203" style="stroke:#181818;stroke-width:1.0;" width="10" x="797.5" y="520.3047"/><rect fill="#FFFFFF" height="28" style="stroke:#181818;stroke-width:1.0;" width="10" x="802.5" y="575.8984"/><rect fill="#FFFFFF" height="630.1797" style="stroke:#181818;stroke-width:1.0;" width="10" x="1077.5" y="405.4453"/><rect fill="#FFFFFF" height="38.1992" style="stroke:#181818;stroke-width:1.0;" width="10" x="1082.5" y="724.2305"/><rect fill="#FFFFFF" height="778.0391" style="stroke:#181818;stroke-width:1.0;" width="10" x="1237.5" y="257.5859"/><rect fill="#FFFFFF" height="91.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="1242.5" y="944.2266"/><rect fill="#FFFFFF" height="16" style="stroke:#181818;stroke-width:1.0;" width="10" x="1247.5" y="1019.625"/><polygon fill="#181818" points="21,84.7266,31,88.7266,21,92.7266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="0" x2="27" y1="88.7266" y2="88.7266"/><line style="stroke:#181818;stroke-width:1.0;" x1="48" x2="90" y1="117.8594" y2="117.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="90" x2="90" y1="117.8594" y2="130.8594"/><line style="stroke:#181818;stroke-width:1.0;" x1="49" x2="90" y1="130.8594" y2="130.8594"/><polygon fill="#181818" points="59,126.8594,49,130.8594,59,134.8594" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="55" y="112.7935">create communication channels</text><line style="stroke:#181818;stroke-width:1.0;" x1="270" x2="260" y1="189.9922" y2="185.9922"/><line style="stroke:#181818;stroke-width:1.0;" x1="270" x2="260" y1="189.9922" y2="193.9922"/><line style="stroke:#181818;stroke-width:1.0;" x1="43" x2="271" y1="189.9922" y2="189.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="50" y="184.9263">create and start in a new thread</text><rect fill="#E3E3E3" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="272" y="168.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="281.5" y="188.8545">&lt;&lt;thread&gt;&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="279" y="205.1514">AnkaiosServer</text><line style="stroke:#181818;stroke-width:1.0;" x1="429" x2="419" y1="247.5859" y2="243.5859"/><line style="stroke:#181818;stroke-width:1.0;" x1="429" x2="419" y1="247.5859" y2="251.5859"/><line style="stroke:#181818;stroke-width:1.0;" x1="43" x2="430" y1="247.5859" y2="247.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="50" y="242.52">create and start in a new thread</text><rect fill="#E3E3E3" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="214" x="431" y="226.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="491.5" y="246.4482">&lt;&lt;thread&gt;&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="200" x="438" y="262.7451">GRPCCommunicationsServer</text><path d="M421,291.0469 L498,291.0469 L498,298.1797 L488,308.1797 L421,308.1797 L421,291.0469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="76.2656" style="stroke:#000000;stroke-width:1.5;" width="888" x="421" y="291.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="436" y="304.1138">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="72" x="513" y="303.2573">[per agent]</text><polygon fill="#181818" points="559,325.3125,549,329.3125,559,333.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="553" x2="1236.5" y1="329.3125" y2="329.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="565" y="324.2466">agent hello (name)</text><line style="stroke:#181818;stroke-width:1.0;" x1="1007" x2="997" y1="395.4453" y2="391.4453"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007" x2="997" y1="395.4453" y2="399.4453"/><line style="stroke:#181818;stroke-width:1.0;" x1="43" x2="1008" y1="395.4453" y2="395.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="50" y="390.3794">create and start in a new thread</text><rect fill="#E3E3E3" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="147" x="1009" y="374.3125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="1036" y="394.3076">&lt;&lt;thread&gt;&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="133" x="1016" y="410.6045">StartupStateLoader</text><line style="stroke:#181818;stroke-width:1.0;" x1="333" x2="380" y1="463.1719" y2="463.1719"/><line style="stroke:#181818;stroke-width:1.0;" x1="380" x2="380" y1="463.1719" y2="476.1719"/><line style="stroke:#181818;stroke-width:1.0;" x1="339" x2="380" y1="476.1719" y2="476.1719"/><polygon fill="#181818" points="349,472.1719,339,476.1719,349,480.1719" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="345" y="442.9731">start listening for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="345" y="458.106">state change requests</text><line style="stroke:#181818;stroke-width:1.0;" x1="732" x2="722" y1="510.3047" y2="506.3047"/><line style="stroke:#181818;stroke-width:1.0;" x1="732" x2="722" y1="510.3047" y2="514.3047"/><line style="stroke:#181818;stroke-width:1.0;" x1="543" x2="733" y1="510.3047" y2="510.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="550" y="505.2388">spawn gRPC server thread</text><rect fill="#E3E3E3" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="137" x="734" y="489.1719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="756" y="509.167">&lt;&lt;thread&gt;&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123" x="741" y="525.4639">tonic gRPC server</text><line style="stroke:#181818;stroke-width:1.0;" x1="812.5" x2="854.5" y1="567.8984" y2="567.8984"/><line style="stroke:#181818;stroke-width:1.0;" x1="854.5" x2="854.5" y1="567.8984" y2="580.8984"/><line style="stroke:#181818;stroke-width:1.0;" x1="813.5" x2="854.5" y1="580.8984" y2="580.8984"/><polygon fill="#181818" points="823.5,576.8984,813.5,580.8984,823.5,584.8984" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="819.5" y="562.8325">start listening for state change requests</text><line style="stroke:#181818;stroke-width:1.0;" x1="548" x2="590" y1="640.0313" y2="640.0313"/><line style="stroke:#181818;stroke-width:1.0;" x1="590" x2="590" y1="640.0313" y2="653.0313"/><line style="stroke:#181818;stroke-width:1.0;" x1="549" x2="590" y1="653.0313" y2="653.0313"/><polygon fill="#181818" points="559,649.0313,549,653.0313,559,657.0313" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="555" y="634.9653">start listening for execution requests</text><line style="stroke:#181818;stroke-width:1.0;" x1="1087.5" x2="1134.5" y1="711.2305" y2="711.2305"/><line style="stroke:#181818;stroke-width:1.0;" x1="1134.5" x2="1134.5" y1="711.2305" y2="724.2305"/><line style="stroke:#181818;stroke-width:1.0;" x1="1093.5" x2="1134.5" y1="724.2305" y2="724.2305"/><polygon fill="#181818" points="1103.5,720.2305,1093.5,724.2305,1103.5,728.2305" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="1099.5" y="706.1646">load startup config</text><path d="M1230,696.0313 L1230,736.0313 L1438,736.0313 L1438,706.0313 L1428,696.0313 L1230,696.0313 " fill="#FFFFFF" style="stroke:#181818;stroke-width:0.5;"/><path d="M1428,696.0313 L1428,706.0313 L1438,706.0313 L1428,696.0313 " fill="#FFFFFF" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="1236" y="713.0981">Empty state is loaded,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="1236" y="728.231">if the startup config is empty.</text><line style="stroke:#181818;stroke-width:1.0;" x1="344" x2="354" y1="762.4297" y2="758.4297"/><line style="stroke:#181818;stroke-width:1.0;" x1="344" x2="354" y1="762.4297" y2="766.4297"/><line style="stroke:#181818;stroke-width:1.0;" x1="343" x2="1076.5" y1="762.4297" y2="762.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="360" y="757.3638">send startup state</text><line style="stroke:#181818;stroke-width:1.0;" x1="343" x2="390" y1="786.5625" y2="786.5625"/><line style="stroke:#181818;stroke-width:1.0;" x1="390" x2="390" y1="786.5625" y2="799.5625"/><line style="stroke:#181818;stroke-width:1.0;" x1="349" x2="390" y1="799.5625" y2="799.5625"/><polygon fill="#181818" points="359,795.5625,349,799.5625,359,803.5625" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="355" y="781.4966">calculate execution request</text><line style="stroke:#181818;stroke-width:1.0;" x1="536" x2="526" y1="833.6953" y2="829.6953"/><line style="stroke:#181818;stroke-width:1.0;" x1="536" x2="526" y1="833.6953" y2="837.6953"/><line style="stroke:#181818;stroke-width:1.0;" x1="343" x2="537" y1="833.6953" y2="833.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="350" y="828.6294">send execution request</text><line style="stroke:#181818;stroke-width:1.0;" x1="548" x2="595" y1="857.8281" y2="857.8281"/><line style="stroke:#181818;stroke-width:1.0;" x1="595" x2="595" y1="857.8281" y2="870.8281"/><line style="stroke:#181818;stroke-width:1.0;" x1="554" x2="595" y1="870.8281" y2="870.8281"/><polygon fill="#181818" points="564,866.8281,554,870.8281,564,874.8281" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="560" y="852.7622">find concerned agents</text><path d="M421,890.8281 L498,890.8281 L498,897.9609 L488,907.9609 L421,907.9609 L421,890.8281 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="61.3984" style="stroke:#000000;stroke-width:1.5;" width="888" x="421" y="890.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="436" y="903.895">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="104" x="513" y="903.0386">[for each agent]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1240.5" x2="1230.5" y1="944.2266" y2="940.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="1240.5" x2="1230.5" y1="944.2266" y2="948.2266"/><line style="stroke:#181818;stroke-width:1.0;" x1="553" x2="1241.5" y1="944.2266" y2="944.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="560" y="924.0278">send execution request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="560" y="939.1606">with workload list</text><path d="M421,966.2266 L498,966.2266 L498,973.3594 L488,983.3594 L421,983.3594 L421,966.2266 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="61.3984" style="stroke:#000000;stroke-width:1.5;" width="888" x="421" y="966.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="436" y="979.2935">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="142" x="513" y="978.437">[for each other agent]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1245.5" x2="1235.5" y1="1019.625" y2="1015.625"/><line style="stroke:#181818;stroke-width:1.0;" x1="1245.5" x2="1235.5" y1="1019.625" y2="1023.625"/><line style="stroke:#181818;stroke-width:1.0;" x1="553" x2="1246.5" y1="1019.625" y2="1019.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="560" y="999.4263">send execution request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="560" y="1014.5591">with list of workload states</text><!--MD5=[6efd389c453bb29979cc64cd6d6999c5]
@startuml seq_startup
!include ../../../../resources/doc/plantuml/clean.skin

box "Ankaios Server"
participant Main as main
participant "<<thread>>\nAnkaiosServer" as server


participant "<<thread>>\nGRPCCommunicationsServer" as grpc_server
participant "<<thread>>\ntonic gRPC server" as tonic_server


participant "<<thread>>\nStartupStateLoader" as state_loader
end box

box "Ankaios Agent"
    participant "Ankaios Agent" as agent
end box

-> main ++
main -> main ++- -: create communication channels
main ->> server **: create and start in a new thread
activate server
main ->> grpc_server ** : create and start in a new thread
activate grpc_server

activate agent
loop per agent
    agent -> grpc_server ++: agent hello (name)
    deactivate grpc_server
end

main ->> state_loader ** : create and start in a new thread
activate state_loader

server -> server ++: start listening for \nstate change requests

grpc_server ->> tonic_server **: spawn gRPC server thread
activate tonic_server
tonic_server -> tonic_server ++- -: start listening for state change requests

grpc_server -> grpc_server ++- -: start listening for execution requests /'evil laughter'/

state_loader -> state_loader ++: load startup config
note right: Empty state is loaded,\nif the startup config is empty.
state_loader ->> server - -++: send startup state

server -> server ++: calculate execution request

server ->> grpc_server - -++: send execution request

grpc_server -> grpc_server ++: find concerned agents

loop for each agent
    grpc_server ->> agent ++:send execution request \nwith workload list
end
loop for each other agent
    grpc_server ->> agent ++:send execution request \nwith list of workload states
end
@enduml

@startuml seq_startup
skinparam monochrome true
skinparam guillemet true
skinparam style strictuml
hide empty members
hide empty methods

skinparam class {
    BorderColor<<logical entity>> grey
    FontColor<<logical entity>> grey
    StereotypeFontColor<<logical entity>> grey
}

skinparam sequenceBox {
    BorderColor #LightGrey
    BackgroundColor #EEEEEE
    FontColor #777777
}

skinparam BoxPadding 10

skinparam note {
    BackgroundColor #FFFFFF
}

skinparam nodesep 30
skinparam ranksep 30

box "Ankaios Server"
participant Main as main
participant "<<thread>>\nAnkaiosServer" as server


participant "<<thread>>\nGRPCCommunicationsServer" as grpc_server
participant "<<thread>>\ntonic gRPC server" as tonic_server


participant "<<thread>>\nStartupStateLoader" as state_loader
end box

box "Ankaios Agent"
    participant "Ankaios Agent" as agent
end box

-> main ++
main -> main ++- -: create communication channels
main ->> server **: create and start in a new thread
activate server
main ->> grpc_server ** : create and start in a new thread
activate grpc_server

activate agent
loop per agent
    agent -> grpc_server ++: agent hello (name)
    deactivate grpc_server
end

main ->> state_loader ** : create and start in a new thread
activate state_loader

server -> server ++: start listening for \nstate change requests

grpc_server ->> tonic_server **: spawn gRPC server thread
activate tonic_server
tonic_server -> tonic_server ++- -: start listening for state change requests

grpc_server -> grpc_server ++- -: start listening for execution requests 

state_loader -> state_loader ++: load startup config
note right: Empty state is loaded,\nif the startup config is empty.
state_loader ->> server - -++: send startup state

server -> server ++: calculate execution request

server ->> grpc_server - -++: send execution request

grpc_server -> grpc_server ++: find concerned agents

loop for each agent
    grpc_server ->> agent ++:send execution request \nwith workload list
end
loop for each other agent
    grpc_server ->> agent ++:send execution request \nwith list of workload states
end
@enduml

PlantUML version 1.2022.7(Mon Aug 22 17:01:30 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: ANSI_X3.4-1968
Language: en
Country: US
--></g></svg>